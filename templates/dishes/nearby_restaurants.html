{% extends 'base.html' %}
{% load static %}

{% block title %}Nearby Restaurants - Swipe&Bite{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 style="color: #2D3436; font-weight: 700; margin-bottom: 0.25rem;">
                <i class="fas fa-map-marker-alt" style="color: #FD7979; font-size: 1.5rem; margin-right: 0.25rem;"></i> Nearby Restaurants
            </h1>
            <p style="color: #636E72;">Discover restaurants close to you</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{% url 'dishes:restaurant_list' %}" class="btn btn-outline-primary">
                <i class="fas fa-list"></i> View All Restaurants
            </a>
        </div>
    </div>

    <!-- Location Status -->
    {% if user_location %}
        <div class="card mb-4" style="background: linear-gradient(135deg, #FEEAC9 0%, #FFCDC9 100%); border: none;">
            <div class="card-body p-3">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <div style="width: 50px; height: 50px; background: #FFFFFF; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                            <i class="fas fa-map-marker-alt" style="color: #FD7979; font-size: 1.25rem;"></i>
                        </div>
                        <div>
                            <h5 style="color: #2D3436; font-weight: 600; margin: 0;">{{ user_location.city }}</h5>
                            <small style="color: #636E72;">
                                {{ user_location.latitude|floatformat:4 }}, {{ user_location.longitude|floatformat:4 }}
                            </small>
                        </div>
                    </div>
                    <button class="btn" style="background: #FFFFFF; color: #FD7979; font-weight: 600;" data-bs-toggle="modal" data-bs-target="#locationModal">
                        <i class="fas fa-edit"></i> Change Location
                    </button>
                </div>
            </div>
        </div>
    {% else %}
        <div class="card mb-4">
            <div class="card-body text-center p-5">
                <div style="width: 80px; height: 80px; background: #FEEAC9; border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-map-marker-alt" style="color: #FD7979; font-size: 2rem;"></i>
                </div>
                <h4 style="color: #2D3436; font-weight: 600;">Set Your Location</h4>
                <p style="color: #636E72; margin-bottom: 1rem;">We need your location to show nearby restaurants</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#locationModal">
                    <i class="fas fa-location-crosshairs"></i> Set Location Now
                </button>
            </div>
        </div>
    {% endif %}

    {% if user_location %}
        <!-- Distance Filter -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="GET">
                    <div class="row align-items-end">
                        <div class="col-md-3 mb-2">
                            <label class="form-label" style="color: #2D3436; font-weight: 500;">Max Distance</label>
                            <select name="distance" class="form-select">
                                <option value="5" {% if selected_distance == '5' %}selected{% endif %}>Within 5 miles</option>
                                <option value="10" {% if selected_distance == '10' %}selected{% endif %}>Within 10 miles</option>
                                <option value="15" {% if selected_distance == '15' %}selected{% endif %}>Within 15 miles</option>
                                <option value="25" {% if selected_distance == '25' %}selected{% endif %}>Within 25 miles</option>
                                <option value="50" {% if selected_distance == '50' %}selected{% endif %}>Within 50 miles</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-2">
                            <label class="form-label" style="color: #2D3436; font-weight: 500;">Price Range</label>
                            <select name="price" class="form-select">
                                <option value="">All Prices</option>
                                <option value="$" {% if selected_price == '$' %}selected{% endif %}>$ (Budget)</option>
                                <option value="$$" {% if selected_price == '$$' %}selected{% endif %}>$$ (Moderate)</option>
                                <option value="$$$" {% if selected_price == '$$$' %}selected{% endif %}>$$$ (Upscale)</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-2">
                            <label class="form-label" style="color: #2D3436; font-weight: 500;">Min Rating</label>
                            <select name="rating" class="form-select">
                                <option value="">Any Rating</option>
                                <option value="3" {% if selected_rating == '3' %}selected{% endif %}>3+ Stars</option>
                                <option value="4" {% if selected_rating == '4' %}selected{% endif %}>4+ Stars</option>
                                <option value="4.5" {% if selected_rating == '4.5' %}selected{% endif %}>4.5+ Stars</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-2">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-filter"></i> Apply Filters
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Results Count -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <p style="color: #636E72; margin: 0;">
                Found <strong style="color: #FD7979;">{{ restaurants|length }}</strong> restaurants nearby
            </p>
            <div>
                <span style="background: #FEEAC9; color: #FD7979; padding: 0.25rem 0.75rem; border-radius: 8px; font-size: 0.875rem; font-weight: 500;">
                    <i class="fas fa-sort-amount-down"></i> Sorted by distance
                </span>
            </div>
        </div>

        <!-- Restaurants List -->
        <div class="row">
            {% if restaurants %}
                {% for restaurant in restaurants %}
                    <div class="col-md-6 mb-4">
                        <div class="card h-100" style="transition: all 0.2s ease-in-out;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 25px rgba(253,121,121,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.08)';">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div style="flex: 1;">
                                        <h5 style="color: #2D3436; font-weight: 600; margin-bottom: 0.5rem;">{{ restaurant.name }}</h5>
                                        <p style="color: #636E72; font-size: 0.875rem; margin-bottom: 0.25rem;">
                                            <i class="fas fa-map-marker-alt" style="color: #FD7979; font-size: 1rem; margin-right: 0.25rem;"></i>
                                            {{ restaurant.address|truncatewords:5 }}
                                        </p>
                                        <p style="color: #636E72; font-size: 0.875rem; margin-bottom: 0.75rem;">
                                            {{ restaurant.city }}, {{ restaurant.state }}
                                        </p>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="background: #FD7979; color: #FFFFFF; padding: 0.5rem 0.75rem; border-radius: 8px; font-weight: 600; margin-bottom: 0.5rem;">
                                            <i class="fas fa-star"></i> {{ restaurant.rating|floatformat:1 }}
                                        </div>
                                    </div>
                                </div>

                                <!-- Distance Badge - Prominent -->
                                <div class="mb-3">
                                    <span style="background: linear-gradient(135deg, #FEEAC9 0%, #FFCDC9 100%); color: #FD7979; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; display: inline-flex; align-items: center;">
                                        <i class="fas fa-route" style="margin-right: 0.5rem;"></i>
                                        {{ restaurant.distance|floatformat:1 }} miles away
                                    </span>
                                    {% if restaurant.price_range %}
                                        <span style="background: #FAFAFA; color: #636E72; padding: 0.5rem 0.75rem; border-radius: 8px; font-weight: 600; margin-left: 0.5rem;">
                                            {{ restaurant.price_range }}
                                        </span>
                                    {% endif %}
                                </div>

                                <!-- Cuisines -->
                                {% if restaurant.cuisines.all %}
                                    <div class="mb-3">
                                        {% for cuisine in restaurant.cuisines.all|slice:":3" %}
                                            <span style="background: #FAFAFA; color: #636E72; padding: 0.25rem 0.5rem; border-radius: 8px; font-size: 0.75rem; margin-right: 0.25rem;">
                                                {{ cuisine.emoji }} {{ cuisine.name }}
                                            </span>
                                        {% endfor %}
                                    </div>
                                {% endif %}

                                <!-- Actions -->
                                <div class="d-flex gap-2">
                                    <a href="{% url 'dishes:restaurant_detail' restaurant.id %}" class="btn btn-primary flex-grow-1">
                                        <i class="fas fa-eye"></i> View Menu
                                    </a>
                                    <a href="https://www.google.com/maps/search/?api=1&query={{ restaurant.address|urlencode }}+{{ restaurant.city|urlencode }}" target="_blank" class="btn btn-outline-primary">
                                        <i class="fas fa-directions"></i>
                                    </a>
                                    {% if user.is_authenticated %}
                                        {% if restaurant.id in favorite_ids %}
                                            <a href="{% url 'swipes:remove_favorite_restaurant_by_id' restaurant.id %}" class="btn" style="background: #FEEAC9; color: #FD7979;">
                                                <i class="fas fa-heart"></i>
                                            </a>
                                        {% else %}
                                            <a href="{% url 'swipes:add_favorite_restaurant' restaurant.id %}" class="btn btn-outline-primary">
                                                <i class="far fa-heart"></i>
                                            </a>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body text-center p-5">
                            <div style="width: 80px; height: 80px; background: #FEEAC9; border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-store-slash" style="color: #FD7979; font-size: 2rem;"></i>
                            </div>
                            <h4 style="color: #2D3436; font-weight: 600;">No Restaurants Found</h4>
                            <p style="color: #636E72; margin-bottom: 1rem;">Try increasing your search distance or adjusting filters</p>
                            <a href="{% url 'dishes:nearby_restaurants' %}?distance=50" class="btn btn-primary">
                                <i class="fas fa-search-plus"></i> Expand Search to 50 Miles
                            </a>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}
